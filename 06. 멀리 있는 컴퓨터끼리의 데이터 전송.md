
# 06 IP 프로토콜

 



## IPv4 프로토콜

### IPv4가 하는 일

- 네트워크 상에서 데이터를 교환하기 위한 프로토콜
- 데이터가 정확하게 전달될 것을 보장하지 않는다
  - 데이터가 중간에 누락되거나, 잘못되어서 깨질 수 있다
  - 이는, 다른 계층(4계층 등)에서 보완해줄 수 있다
- 데이터의 정확하고 순차적인 전달은 다른 계층에서 함
- 중복된 패킷을 전달하거나 패킷의 순서를 잘못 전달할 가능성도 있다.
  - (악의적으로 이용되면 DoS 공격이 됨)
- 데이터의 정확하고 순차적인 전달은 그보다 상위 프로토콜인 TCP에서 보장한다.



### IPv4 프로토콜의 구조
![image](https://user-images.githubusercontent.com/69442847/197900587-f9f105a3-a09f-45c5-9927-158eb50ca83b.png)

- 최소 20 Byte (4byte씩 5줄) + (옵션붙으면 하나당 4byte, 최대 10개 붙을 수 있음)
- Flags : 내 뒤에 패킷이 더 있는지
- Fragment Offset : offset을 그냥 쓰지 않고 8로 나눠서 씀
- 패킷의 오프셋으로 순서를 맞추게 됨!



## ICMP 프로토콜

### ICMP가 하는 일

- **Internet Control Message Protocol, 인터넷 제어 메세지 프로토콜**
- 네트워크 컴퓨터 위에서 돌아가는 OS에서 오류 메시지를 전송받는데 주로 쓰인다
- 프로토콜 구조의 Type과 Code를 통해 오류 메시지를 전송받는다. 상대방과 통신이 되는지 안 되는지 확인하기 위한 용도로 많이 쓰인다.



### ICMP 프로토콜의 구조

![img](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/ICMP_header_-_General-en.svg/300px-ICMP_header_-_General-en.svg.png)

![img](https://image.slidesharecdn.com/internetcontrolmessageprotocol-121115085749-phpapp01/95/internet-control-message-protocol-13-638.jpg?cb=1352969905)

- 타입 0,8 코드 3,11 은 알아두는게 좋다
- Type: 카테고리 중 대분류, 0, 3, 8, 10, 11 ... 등 Message Type 들이 있다. 
  - 8번은 요청, 0번은 응답, 
  - 3번은 Destination Unreachable(가는 경로 상 문제), 
  - 11번은 Time exceed(상대방 쪽 문제, 방화벽 등). 해당 코드로 네트워크가 안될 때 message를 통해 왜 안되는지에 대한 이유를 알 수 있다. 
  - 5번은 ICMP redirect(원격지에 있는 상대방의 라우팅 테이블을 ICMP를 통해 수정할 때 사용->보안 문제 )
- Code: 카테고리 중 소분류
- Checksum: 해당 헤더에 오류가 있는지 확인할 수 있는 값. 패킷의 리시버가 헤더의 속성값들을 더하여 Checksum과 비교. 만약 같다면 오류 없이 전달 받은 것.

## 라우팅 테이블
### 내가 보낸 패킷은 어디로 가는가
```netstat -r```
어디로 보내야 하는지 설정되어 있는 라우팅 테이블
지도 같은 개념으로 라우팅 테이블에 적혀있는 부분만 찾아갈 수 있고, 적혀있지 않은 부분은 찾아갈 수 없음
보통 라우팅 테이블을 작성할 때 기본 값을 넣어줌.(기본 게이트웨이 ..)

## 다른 네트워크와 통신 과정
### 다른 네트워크까지 내 패킷의 이동 과정
보낼 라우팅 테이블에 해당 패킷을 받을 네트워크 대역이 있어야 전송이 가능

## IPv4의 조각화

### 조각화란?

- 큰 IP 패킷들이 적은 MTU(Maximum Transmission Unit)를 갖는 링크를 통해 전송되려면 여러 개의 작은 패킷으로 쪼개서/조각화돼서 전송돼야한다.
- 큰 데이터를 여러 개의 패킷으로 조각화
- 만약 MTU 가 980이면 IPv4 20바이트 빼고 960Byte의 데이터만 보낼수있다는 뜻


## IPv4, ICMP 프로토콜 실습
### ping 입력
![](https://velog.velcdn.com/images/zioo/post/8fb009c6-1da9-494c-9cef-62d7ded45e7f/image.png)

### wireshark에서 필터에 icmp 적용 
![](https://velog.velcdn.com/images/zioo/post/6b28919b-43df-4fb2-bda0-f20cd3495757/image.png)

출발지 : 내 ip 주소 
목적지 : ping 한 곳 
![](https://velog.velcdn.com/images/zioo/post/6e7d91ea-fffa-4f79-8825-a7fae842977b/image.png)

### 패킷 확인 
![](https://velog.velcdn.com/images/zioo/post/7d546d37-95f5-4e6f-aa11-35807389f106/image.png)
![](https://velog.velcdn.com/images/zioo/post/28f5b2c8-7d86-4bb4-b388-f6233f93ea51/image.png)
icmp가 통신확인할 때 자기 자신만 보내는게 아니라 쓸데없는 정보도 같이 보낸다. 
앞에 8 byte만 icmp
요청할 때 : type 08

![](https://velog.velcdn.com/images/zioo/post/f12d8069-7f67-4d84-8ec6-fbf3fcd2b4c7/image.png)
### IPv4 프로토콜
![](https://velog.velcdn.com/images/zioo/post/5b98c6c4-f1d3-4033-9975-3344a6f20dd2/image.png)
- Version : 16진수 하나로 4라고 씀
- Header Length : 20bytes 4로 나눠서 5
- Total Length : payload까지 합친 길이 60 byte
- Identification : 고유한 id 값

![](https://velog.velcdn.com/images/zioo/post/a6796b47-24d9-47cb-9d68-e06f45e7c99f/image.png)
- flag : 조각화가 됐는지 안 됐는지 확인 
  - 3bit로 표현
  - 1번째는 안 씀
- Don't fragments : 내가 조각화가 필요한데 사용하지 않겠다.
- More fragments : 내 뒤에 조각화된 패킷이 있으니 기다려라 
- Fragment offset : 첫번째에서부터 얼마나 떨어져 있는지 확인
- Time to live : 네트워크 장비 하나씩 지나갈 때마다 1 감소, 윈도우는 기본 128, 지금은 내가 보내는 상황이기 때문에 네트워크 장비 아직 안 지나감
- Protocol : 프로토콜 부분에 상위 프로토콜 지정 
- Source : 출발지 IP 주소 
- Destination : 도착지 IP 주소 
#### 구글이랑 통신을 할 때 내가 보낸 것과 구글이 받을 때 
- 이더넷 프로토콜 다름
- IPv4 프로토콜은 동일

--------
## 라우팅 테이블 및 전송 과정 
또로리님 부분,,,,
![](https://velog.velcdn.com/images/zioo/post/136cd3dd-5748-4fb3-93ac-494b4603a64e/image.png)


![](https://velog.velcdn.com/images/zioo/post/62cc660d-a1c8-43a1-bfe1-d5850977e260/image.png)

![](https://velog.velcdn.com/images/zioo/post/0871c93a-1a14-4ea5-b4c8-8c098e37a3f1/image.png)
![](https://velog.velcdn.com/images/zioo/post/90a29a00-9417-42f9-8dbd-30e7f58be7c8/image.png)
![](https://velog.velcdn.com/images/zioo/post/609d1d51-d9e6-4491-a102-496645bf3bfd/image.png)
![](https://velog.velcdn.com/images/zioo/post/10503791-1f04-48c5-ab52-8dd5ed93a08f/image.png)






----
## 라우팅 테이블 확인 실습 
### 라우팅 테이블 확인 
![](https://velog.velcdn.com/images/zioo/post/9f45e1d1-a102-4e13-9218-b2ac0df1340b/image.png)

![](https://velog.velcdn.com/images/zioo/post/ae7b7fee-ffcd-4d66-9706-a99c29aee8e6/image.png)




------

[출처 블로그](https://velog.io/@ppmyor/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-06.-%EB%A9%80%EB%A6%AC-%EC%9E%88%EB%8A%94-%EC%BB%B4%ED%93%A8%ED%84%B0%EB%81%BC%EB%A6%AC%EB%8A%94-%EC%9D%B4%EB%A0%87%EA%B2%8C-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%A5%BC-%EC%A3%BC%EA%B3%A0%EB%B0%9B%EB%8A%94%EB%8B%A4)
